<html>

<head>
    
    <style type="text/css">

        .addressbook-table-add {
            position: relative;
            width: 30px;
            height: 30px;
            border-radius:20%;
            margin-bottom: 4px;
        }
        .addressbook-table {
            display: table;
            
        }

        .addressbook-table .thead {
            display: table-header-group;
            font-family:monospace;

        }

        .addressbook-table .tbody {
            display: table-row-group;
            font-family:monospace;

        }

        .addressbook-table .tr {
            display: table-row-group;
            width: 660px;

        }

        .addressbook-table .th,
        .addressbook-table .td {
            text-align:center;
            width: 180px;
            border: 0.5px solid navy;
            padding: 1px;
            display: table-cell;

        }
        .addressbook-table .tbody button{
            position: relative;
            width: 30px;
            height: 30px;
            border-radius:20%;
            margin-bottom: 4px;
           

        }
    </style>
    
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <!-- 選擇所需圖示類型的載入 -->
    <!-- 這裡會載入 solid 和 regular 這兩類的圖示，最後要記得載入 fontawesome.js -->
    <script src="https://use.fontawesome.com/releases/v5.0.0/js/solid.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.0.0/js/regular.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.0.0/js/fontawesome.js"></script>
</head>

<body>
    
    <div>
        <h2 style="text-align:center"> AddressBook_lab</h2>
        
    </div>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css"></script>

        <button id="add-btn" class="addressbook-table-add"><i class="fas fa-plus-square"></i></button>
        <BR>
        <div class="addressbook-table">
            <div class="thead">
                <div class="tr">
                    <div  class="th">No(編號)</div>
                    <div  class="th">Name(姓名)</div>
                    <div  class="th">tel(電話)</div>
                    <div  class="th">type(類型)</div>
                    <div  class="th">notes(備註)</div>
                    <div  class="th">function(功能)</div>
                </div>
            </div>
            <div class="tbody">
            </div>
        </div>
    
<!--樣板-->
<span id="temp" style="display: none">
<div id="div-tr-temp" class="tr"  >
        <div id="no" class="td"><div class="text" style="display: none;"></div><input type="text"></div>
        <div id="name" class="td"><div class="text"></div><input type="text"></div>
        <div id="tel" class="td"><div class="text"></div><input type="text"></div>
        <div id="type" class="td"><div class="text"></div>
                                <div class="selectIndex" style="display: none;"></div>  
            <select>
                <option>同學</option>
                <option>家庭</option>
                <option>工作夥伴</option>
            </select>
        </div>
        <div id="notes" class="td"><div class="text"></div><textarea></textarea></div>
        <div id="function" class="td">
            <button id="save-btn" class="save-btn"><i class="fas fa-save"></i></button>
            <button id="cancel-btn" class="cancel-btn"><i class="fas fa-window-close"></i></button>
            <button id="edit-btn" class="edit-btn" style="display: none;"><i class="fas fa-pen-square"></i></button>
            <button id="del-btn" class="del-btn" style="display: none;"><i class="far fa-trash-alt"></i></button>
        </div>
</div>
</span>
</body>
<script>
    // var loc_property = "";
    var map_multi_data=new Map();
    function save_process(obj){
        var map_sing_data = new Map();
        var name_obj = obj.find("#name");
        var tel_obj = obj.find("#tel");
        var type_obj = obj.find("#type");//取得type obj
        // var type_index = type_obj.find($("select"))[0].selectedIndex;//取得type  option 的索引
        // var type =type_obj.find($("select > option:selected")).val();
        var notes_obj = obj.find("#notes");
        var arr = get_tr_property(obj);      
        // 將資料存入並轉成顯示模式
        setText(name_obj.find(".text"),arr[0]);
        setText(tel_obj.find(".text"),arr[1]);
        setText(notes_obj.find(".text"),arr[2]);
        setText(type_obj.find(".text"),arr[3]);
        setText(type_obj.find(".selectIndex"),arr[4]);
        // 將資料以k,v 格式存入arr{map}中
        map_sing_data.set("name",arr[0]);
        map_sing_data.set("tel",arr[1]);        
        map_sing_data.set("notes",arr[2]);
        map_sing_data.set("type",arr[3]);
        map_sing_data.set("type_index",arr[4]);
    	return map_sing_data;
    }
    function get_tr_property(obj){
        var arr_val = new Array();
        var name = obj.find($("#name > input")).val();//取得name 內的值
        var tel = obj.find($("#tel > input")).val();//取得tel 內的值
        var notes = obj.find($("#notes > textarea")).val();//取得notes textarea的值   
        var type_obj = obj.find("#type");//取得type obj
        var type =type_obj.find($("select > option:selected")).val();
        var type_index = type_obj.find($("select"))[0].selectedIndex;//取得type  option 的索引
        arr_val=[name,tel,notes,type,type_index];
        // arr_val.push(name);
        // arr_val.push(tel);
        // arr_val.push(notes);
        // arr_val.push(type);
        // arr_val.push(type_index);
        return arr_val;
    }
    function getID(str){
    	var id = $(str).prop("id");
    	return id;
    }
    function setText(obj,str){
    	 obj.text(str);
    }
    function getTrObjFromBtn(obj){
    	 return obj.parent().parent();
    }
    function readModeBtn(obj){
        obj.find($("input")).hide();
        obj.find($("select")).hide();
        obj.find($("textarea")).hide();
        obj.find($(".save-btn")).hide();
        obj.find($(".cancel-btn")).hide();
        obj.find($(".edit-btn")).show();
        obj.find($(".del-btn")).show();
        obj.find("#no >.text").show();
        obj.find("#name > .text").show();
        obj.find("#tel > .text").show();
        obj.find("#type > .text").show();
        obj.find("#notes > .text").show();
    }
    function editModeBtn(obj){
        obj.find($("input")).show();
        obj.find($("select")).show();
        obj.find($("textarea")).show();
        obj.find($(".save-btn")).show();
        obj.find($(".cancel-btn")).show();
        obj.find($(".edit-btn")).hide();
        obj.find($(".del-btn")).hide();
        obj.find("#no >.text").hide();
        obj.find("#name > .text").hide();
        obj.find("#tel > .text").hide();
        obj.find("#type > .text").hide();
        obj.find("#notes > .text").hide();
    }
    /*新增動作
    1.新增一個樣板
    2.將新增按鈕隱藏
    */
    $("#add-btn").click(function () {
        var obj_div_tr_temp =  $("#temp > #div-tr-temp");//取得dom 物件
        var str_div_temp = obj_div_tr_temp.prop("outerHTML");//取得HTML
        var id_div_tr_temp = getID(obj_div_tr_temp);//取得tr_id 值

        $(".tbody ").append(str_div_temp);//將樣板塞入
        var new_obj_div_tr_temp =$(".tbody").find($("#div-tr-temp"));//取得新樣板
        var new_obj_div_tr_temp_save_btn =$(".tbody").find($("#save-btn"));//取得新樣板之save-btn
        var new_obj_div_tr_temp_cancel_btn =$(".tbody").find($("#cancel-btn"));//取得新樣板之cancel-btn
        var id_save_btn = getID(new_obj_div_tr_temp_save_btn);
        var id_cancel_btn = getID(new_obj_div_tr_temp_cancel_btn);
        // $(".tbody .tr #no input").last().attr("disabled",true).val(no_index);//將第一個屬性設為disabled 並加index新增
        
        var tr_size = $(".tbody > .tr").length;//取得 tbody > .tr element 的數量
        $(".tbody .tr #no input").last().attr("disabled",true).val(tr_size);//
        $(".tbody .tr #no .text").last().text(tr_size);
        console.log("index :"+tr_size);

        // disabled add-btn 
        // $("#add-btn").attr('disabled',true);
        
    });
   
    /*
    0.儲存動作
    1.將樣板內容input 存起來
    2.將input的元素隱藏，將填入的值放入.text 的元素。
    3.將填入的值 經由 集合{鍵值組}儲存
    */
    $(".tbody").on("click",".save-btn",function () {
        // var map_sing_data=new Map();
    	var obj_div_tr = getTrObjFromBtn($(this));//取得按鈕上的tr
        var map_sing_data = save_process(obj_div_tr);
        var no = obj_div_tr.find($("#no > input")).val();//取得no 內的值
        // var name = obj_div_tr.find($("#name > input")).val();//取得name 內的值
        // var tel = obj_div_tr.find($("#tel > input")).val();//取得tel 內的值
        // // var typeIndex = obj_div_tr.find($("#type >  select > option:selected")).index();//取得type  option 的索引
        // var name_obj = obj_div_tr.find("#name");
        // var tel_obj = obj_div_tr.find("#tel");
        // var type_obj = obj_div_tr.find("#type");//取得type obj
        // var notes_obj = obj_div_tr.find("#notes");
        // var typeIndex = type_obj.find($("select"))[0].selectedIndex;//取得type  option 的索引
        // var type =type_obj.find($("select > option:selected")).val();
        // var notes = obj_div_tr.find($("#notes > textarea")).val();//取得notes textarea的值
        
    	// console.log(no+name+tel+typeIndex+notes+type);
    	
        map_multi_data.set(no,map_sing_data);        

        // 將編輯格式隱藏
        readModeBtn(obj_div_tr);
        console.log(map_multi_data);

    });

    /*
    0.點選pencil進入編輯模式
    1.將樣板內容 隱藏，將input 顯示
    */
    $(".tbody").on("click",".edit-btn",function () {
        var obj_div_tr = getTrObjFromBtn($(this));//取得按鈕上的tr
        //將閱讀格式隱藏，將原text欄位隱藏
        editModeBtn(obj_div_tr);       
    });
    /*
    0.點選x-btn 將編輯模式取消，回到顯示模式
    1.將樣板內容 顯示，將input 隱藏
    2.將.text 資料塞回 input,textarea,select
    */
    $(".tbody").on("click",".cancel-btn",function () {
        var obj_div_tr = getTrObjFromBtn($(this));//取得按鈕上的tr
        var name = obj_div_tr.find($("#name > .text")).text();//取得name 內的值
        var tel = obj_div_tr.find($("#tel > .text")).text();//取得tel 內的值
        var notes = obj_div_tr.find($("#notes > .text")).text();//取得notes textarea的值
        //取消後將資料復原
        obj_div_tr.find("#name > input").val(name);
        obj_div_tr.find("#tel > input").val(tel);
        obj_div_tr.find("select")[0].selectedIndex=obj_div_tr.find(".selectIndex").text();
        obj_div_tr.find("#notes > textarea").val(notes);
        console.log(no+name+tel+notes);
        //將閱讀格式隱藏，將原text欄位隱藏
        readModeBtn(obj_div_tr);      
    });
    /*
    0.點選garbage-btn 將編輯模式取消，回到顯示模式
    1.將tr元素移除、清空
    */
    $(".tbody").on("click",".del-btn",function () {
        var obj_div_tr = getTrObjFromBtn($(this));//取得按鈕上的tr
        var name = obj_div_tr.find("#name .text").text();
        var check = confirm("Are you sure you want to delete "+name+"from AddressBook?");
        
        if(check){
            map_multi_data=new Map();//將資料刷新重新存           
            obj_div_tr.remove();//將tr元素移除、清空
            var obj_tbody_tr = $(".tbody > .tr");//重新取得現有的element_tr
            obj_tbody_tr.each(function(index,value){//將序號逐筆更新,把資料存入map_multi_dat
                var num = parseInt(index)+1;
                var map_sing_data=new Map();  
				// console.log('del :'+num);
                var obj_div_tr = $(this);
                // var type_obj = obj_div_tr.find("#type");//取得type obj
                // var type =type_obj.find($("select > option:selected")).val();
                // var type_index = type_obj.find($("select"))[0].selectedIndex;//取得type  option 的索引
                var arr = get_tr_property(obj_div_tr);
                // 將資料以k,v 格式存入arr{map}中
                map_sing_data.set("name",arr[0]);
                map_sing_data.set("tel",arr[1]);        
                map_sing_data.set("notes",arr[2]);
                map_sing_data.set("type",arr[3]);
                map_sing_data.set("type_index",arr[4]);
                map_multi_data.set(num,map_sing_data); 
                         	
				$(this).find("#no > .text").text(num);
				$(this).find("#no > input").val(num);
            });
            console.log(map_multi_data);  
            
        }
    });



</script>

</html>